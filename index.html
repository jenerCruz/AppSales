<!DOCTYPE html>
<html lang="es" class="h-full bg-slate-100">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel de Ventas y Metas — PWA</title>

  <!-- Tailwind local -->
  <link rel="stylesheet" href="./assets/css/tailwind.min.css">

  <!-- Manifest -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0ea5e9">

  <!-- Lucide icons -->
  <script defer src="./assets/js/lucide.min.js"></script>

  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .tab-btn { padding:.6rem 1rem; font-weight:500; color:#6b7280; border-bottom:2px solid transparent; border-radius:.375rem .375rem 0 0; }
    .tab-btn.active { color:#0ea5e9; border-bottom-color:#0ea5e9; }
    .tab-content { padding:1rem; background:white; border-radius:.5rem; box-shadow:0 1px 4px rgba(2,6,23,.04); }
    #toast { transition: transform .25s ease, opacity .25s ease; }
  </style>
</head>

<body class="h-full text-slate-800">

  <!-- Header -->
  <header class="bg-slate-800 text-white shadow-lg">
    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold tracking-tight">Panel de Control de Ventas</h1>
      <div id="db-status" class="text-xs text-red-400">Conectando a BD...</div>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto max-w-7xl p-4 sm:px-6 lg:px-8 py-6">

    <!-- Tabs (CORREGIDOS) -->
    <div class="mb-4 border-b border-gray-200">
      <ul class="flex flex-wrap -mb-px">
        <li><button class="tab-btn active" data-tab="dashboard">Dashboard</button></li>
        <li><button class="tab-btn" data-tab="metas">Metas</button></li>
        <li><button class="tab-btn" data-tab="ventas">Registro y Promotores</button></li>
        <li><button class="tab-btn" data-tab="settings">Configuración</button></li>
      </ul>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="tab-content space-y-6">
      <h2 class="text-xl font-semibold text-slate-700">Avances Generales (Mes Actual)</h2>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Bar Chart -->
        <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow-inner border border-slate-200">
          <h3 class="text-lg font-medium mb-3">Avance por Producto</h3>
          <div class="h-64 md:h-80">
            <canvas id="barChart"></canvas>
          </div>
        </div>

        <!-- Donut -->
        <div class="bg-white p-4 rounded-lg shadow-inner border border-slate-200">
          <h3 class="text-lg font-medium mb-3">Meta General del Mes</h3>
          <div class="h-64 md:h-80 flex items-center justify-center relative">
            <canvas id="donutChart"></canvas>
            <div id="donut-percentage" class="absolute text-3xl font-bold text-slate-700">0%</div>
          </div>
        </div>

      </div>

      <div>
        <h2 class="text-xl font-semibold text-slate-700 mb-4">Avance por Sucursal (Mes Actual)</h2>
        <div id="sucursal-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          <p class="text-slate-500">Cargando datos de sucursales...</p>
        </div>
      </div>

      <!-- Productividad por promotor -->
      <div class="mt-6">
        <h2 class="text-xl font-semibold text-slate-700 mb-4">Productividad por Promotor (Mes Actual)</h2>
        <div id="productivity-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <p class="text-slate-500">Cargando productividad...</p>
        </div>
      </div>
    </div>

    <!-- Metas -->
    <div id="metas" class="tab-content hidden space-y-6">
      <h2 class="text-xl font-semibold text-slate-700">Establecer Metas Mensuales</h2>

      <form id="form-metas" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end p-4 bg-slate-50 rounded-lg border">
        <div>
          <label for="meta-mes" class="block text-sm font-medium text-gray-700">Mes</label>
          <select id="meta-mes" name="mes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></select>
        </div>

        <div>
          <label for="meta-sucursal" class="block text-sm font-medium text-gray-700">Sucursal</label>
          <select id="meta-sucursal" name="sucursal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></select>
        </div>

        <div>
          <label for="meta-producto" class="block text-sm font-medium text-gray-700">Producto</label>
          <select id="meta-producto" name="producto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></select>
        </div>

        <div>
          <label for="meta-cantidad" class="block text-sm font-medium text-gray-700">Meta (Piezas)</label>
          <input type="number" id="meta-cantidad" name="meta" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Ej: 50">
        </div>

        <button type="submit" class="w-full md:w-auto text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5">Guardar Meta</button>
      </form>

      <div>
        <h3 class="text-lg font-medium text-slate-700 mb-2">Metas Guardadas</h3>
        <div class="max-h-96 overflow-y-auto rounded-lg border">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mes</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursal</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Meta</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acción</th>
              </tr>
            </thead>

            <tbody id="lista-metas" class="bg-white divide-y divide-gray-200">
              <tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">No hay metas guardadas.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
<!-- Ventas y Promotores -->
    <div id="ventas" class="tab-content hidden space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
          <h2 class="text-xl font-semibold text-slate-700">Registro de Venta Diaria</h2>
          <form id="form-ventas" class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg border">
            <div>
              <label for="venta-fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
              <input type="date" id="venta-fecha" name="fecha" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" required>
            </div>

            <div>
              <label for="venta-sucursal" class="block text-sm font-medium text-gray-700">Sucursal</label>
              <select id="venta-sucursal" name="sucursal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" required></select>
            </div>

            <div>
              <label for="venta-producto" class="block text-sm font-medium text-gray-700">Producto</label>
              <select id="venta-producto" name="producto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" required></select>
            </div>

            <div>
              <label for="venta-promotor" class="block text-sm font-medium text-gray-700">Promotor</label>
              <select id="venta-promotor" name="promotor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" required>
                <option value="">Seleccione un promotor...</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label for="venta-cantidad" class="block text-sm font-medium text-gray-700">Cantidad Vendida</label>
              <input type="number" id="venta-cantidad" name="cantidad" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Ej: 5" required>
            </div>

            <div class="md:col-span-2">
              <button type="submit" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5">Registrar Venta</button>
            </div>
          </form>

          <div>
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-medium text-slate-700">Ventas Registradas</h3>
              <div>
                <button class="px-3 py-1 text-sm rounded-md bg-blue-100 text-blue-700 font-medium">Panel</button>
                <button class="px-3 py-1 text-sm rounded-md text-slate-500 hover:bg-slate-100" title="La vista de calendario es una futura mejora">Calendario</button>
              </div>
            </div>

            <div class="max-h-96 overflow-y-auto rounded-lg border">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursal</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cant.</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Promotor</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acción</th>
                  </tr>
                </thead>
                <tbody id="lista-ventas" class="bg-white divide-y divide-gray-200">
                  <tr><td colspan="6" class="px-6 py-4 text-center text-slate-500">No hay ventas registradas.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <div class="space-y-6">
          <h2 class="text-xl font-semibold text-slate-700">Gestión de Promotores</h2>

          <form id="form-promotores" class="p-4 bg-slate-50 rounded-lg border">
            <label for="promotor-nombre" class="block text-sm font-medium text-gray-700">Nombre del Promotor</label>
            <input type="text" id="promotor-nombre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Ej: Juan Pérez" required>

            <label for="promotor-sucursal" class="block text-sm font-medium text-gray-700 mt-3">Sucursal</label>
            <select id="promotor-sucursal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
              <!-- Opciones generadas por JS -->
            </select>

            <button type="submit" class="mt-3 w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5">Agregar Promotor</button>
          </form>

          <div>
            <h3 class="text-lg font-medium text-slate-700 mb-2">Lista de Promotores</h3>
            <div id="lista-promotores" class="max-h-60 overflow-y-auto space-y-2">
              <p class="text-slate-500">Cargando promotores...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div id="settings" class="tab-content hidden space-y-6">
      <h2 class="text-xl font-semibold text-slate-700">Configuración y Sincronización</h2>
      <section class="p-4 bg-slate-50 rounded-lg border">
        <p class="text-sm text-slate-600 mb-3">Sincroniza tus datos con GitHub Gist (archivo ventas_data.json).</p>
        <form id="gist-config-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
          <div>
            <label for="gist-id" class="block text-sm font-medium text-gray-700">Gist ID</label>
            <input id="gist-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="ej: a1b2c3...">
          </div>

          <div>
            <label for="gist-token" class="block text-sm font-medium text-gray-700">Personal Access Token</label>
            <input id="gist-token" type="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="ghp_xxx...">
          </div>

          <div>
            <button id="btn-save-gist" class="px-4 py-2 text-white bg-indigo-600 rounded-lg">Guardar</button>
          </div>

          <div class="flex space-x-2">
            <button id="btn-download-gist" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg">Descargar</button>
            <button id="btn-upload-gist" class="px-4 py-2 bg-green-600 text-white rounded-lg">Subir</button>
          </div>
        </form>
      </section>
    </div>

  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white opacity-0 translate-y-10">
    <span id="toast-message"></span>
  </div>

  <!-- Modal simple (reutilizable) -->
  <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 invisible">
    <div class="modal-content bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
      <h3 id="message-title" class="text-xl font-semibold mb-2">Título</h3>
      <div id="message-body" class="text-slate-700 mb-4"></div>
      <div class="flex justify-end">
        <button onclick="closeMessageModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Scripts: Chart.js local (UMD) -->
  <script src="./assets/js/chart.umd.min.js"></script>

  <!-- Aquí comienza la LÓGICA JavaScript (PARTE 3/3) -->
<script>
/* ===========================================================
   CONSTANTES Y DATOS
   =========================================================== */
const SUCURSALES = [
  "Coppel 363","Coppel 385","Coppel 716",
  "Elektra 218","Chedraui 23","Chedraui 99","Chedraui 105"
];
const PRODUCTOS = ["Amigo Kit","CGI Cero","Chip Express","Portabilidad","B63"];
const MESES = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

const DB_NAME = "VentasAppDB";
const DB_VERSION = 1;
const STORES = { METAS:"metas", VENTAS:"ventas", PROMOTORES:"promotores", CONFIG:"config" };

let db = null;
let promotoresCache = [];
let barChartInstance = null;
let donutChartInstance = null;

/* ===========================================================
   INICIALIZACIÓN APP
   =========================================================== */
window.addEventListener("load", () => {
  setTodayDate();
  setupTabListeners();
  setupFormListeners();
  initDB();

  // Modal: cierre seguro
  const msgModal = document.getElementById('message-modal');
  if (msgModal) {
    msgModal.addEventListener('click', () => closeMessageModal());
    msgModal.querySelector('.modal-content')?.addEventListener('click', e => e.stopPropagation());
  }
});

function setTodayDate() {
  const today = new Date().toISOString().split("T")[0];
  const fecha = document.getElementById("venta-fecha");
  if (fecha) fecha.value = today;
}

/* ===========================================================
   SISTEMA DE PESTAÑAS (CORREGIDO)
   =========================================================== */
function setupTabListeners() {
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const tabId = btn.dataset.tab;
      showTab(tabId);
    });
  });
}

function showTab(tabId) {
  console.log("→ Cambiando a tab:", tabId);

  // Ocultar todas:
  document.querySelectorAll(".tab-content")
    .forEach(tab => tab.classList.add("hidden"));

  // Desactivar botones:
  document.querySelectorAll(".tab-btn")
    .forEach(btn => btn.classList.remove("active"));

  // Mostrar tab seleccionada:
  const tab = document.getElementById(tabId);
  if (tab) tab.classList.remove("hidden");

  // Activar botón que corresponde:
  const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
  if (btn) btn.classList.add("active");

  // Cargas específicas:
  switch (tabId) {
    case "dashboard":
      setTimeout(() => loadDashboardData(), 50); 
      break;

    case "metas":
      loadMetas();
      break;

    case "ventas":
      populateAllSelects();
      loadPromotores();
      loadVentas();
      break;

    case "settings":
      loadGistConfigLocal();
      break;
  }
}

/* ===========================================================
   IndexedDB: apertura / creación
   =========================================================== */
function initDB() {
  const request = indexedDB.open(DB_NAME, DB_VERSION);

  request.onerror = event => {
    updateDbStatus("Error de BD", true);
    console.error(event.target.error);
  };

  request.onsuccess = event => {
    db = event.target.result;
    updateDbStatus("BD Conectada");
    startApp();
  };

  request.onupgradeneeded = event => {
    const dbu = event.target.result;

    if (!dbu.objectStoreNames.contains(STORES.PROMOTORES)) {
      dbu.createObjectStore(STORES.PROMOTORES, { keyPath:"id", autoIncrement:true });
    }

    if (!dbu.objectStoreNames.contains(STORES.METAS)) {
      const metas = dbu.createObjectStore(STORES.METAS, { keyPath:"id", autoIncrement:true });
      metas.createIndex("metaUnica", ["mes","sucursal","producto"], { unique:true });
    }

    if (!dbu.objectStoreNames.contains(STORES.VENTAS)) {
      const ventas = dbu.createObjectStore(STORES.VENTAS, { keyPath:"id", autoIncrement:true });
      ventas.createIndex("fecha","fecha");
    }

    if (!dbu.objectStoreNames.contains(STORES.CONFIG)) {
      dbu.createObjectStore(STORES.CONFIG, { keyPath:"id" });
    }
  };
}

function updateDbStatus(txt, error=false) {
  const el = document.getElementById("db-status");
  if (!el) return;
  el.textContent = txt;
  el.classList.toggle("text-red-400", error);
  el.classList.toggle("text-green-400", !error);
}

function startApp() {
  populateAllSelects();
  loadPromotores();
  loadMetas();
  loadVentas();
  loadDashboardData();
  loadGistConfigLocal();
}

/* ===========================================================
   SELECTS DE MESES / SUCURSALES / PRODUCTOS
   =========================================================== */
function populateAllSelects() {
  const mes = document.getElementById("meta-mes");
  if (mes) {
    mes.innerHTML = "";
    MESES.forEach((m,i)=> mes.add(new Option(m, i+1)));
    mes.value = new Date().getMonth()+1;
  }

  const selectsSucursal = [
    document.getElementById("meta-sucursal"),
    document.getElementById("venta-sucursal"),
    document.getElementById("promotor-sucursal")
  ];
  selectsSucursal.forEach(sel=>{
    if (!sel) return;
    sel.innerHTML = '<option value="">Seleccione sucursal...</option>';
    SUCURSALES.forEach(s=> sel.add(new Option(s,s)));
  });

  const selectsProducto = [
    document.getElementById("meta-producto"),
    document.getElementById("venta-producto")
  ];
  selectsProducto.forEach(sel=>{
    if (!sel) return;
    sel.innerHTML = '<option value="">Seleccione producto...</option>';
    PRODUCTOS.forEach(p=> sel.add(new Option(p,p)));
  });

  const ventaSucursal = document.getElementById("venta-sucursal");
  if (ventaSucursal) {
    ventaSucursal.addEventListener("change", e => populatePromotoresForSucursal(e.target.value));
  }
}

/* ===========================================================
   PROMOTORES CRUD
   =========================================================== */
function handleAddPromotor(e) {
  e.preventDefault();

  const nombre = document.getElementById("promotor-nombre").value.trim();
  const sucursal = document.getElementById("promotor-sucursal").value;

  if (!nombre) return showToast("Nombre vacío", true);
  if (!sucursal) return showToast("Seleccione sucursal", true);

  const store = db.transaction(STORES.PROMOTORES, "readwrite").objectStore(STORES.PROMOTORES);
  const req = store.add({ nombre, sucursal });

  req.onsuccess = () => {
    showToast("Promotor agregado");
    document.getElementById("promotor-nombre").value = "";
    loadPromotores();
  };
}

async function loadPromotores() {
  const promotores = await getAllFromDB(STORES.PROMOTORES);
  promotoresCache = promotores;

  const lista = document.getElementById("lista-promotores");
  const selectVenta = document.getElementById("venta-promotor");

  lista.innerHTML = "";
  if (selectVenta) selectVenta.innerHTML = '<option value="">Seleccione un promotor...</option>';

  if (promotores.length === 0) {
    lista.innerHTML = '<p class="text-slate-500">No hay promotores registrados.</p>';
    populatePromotoresForSucursal("");
    return;
  }

  promotores.forEach(p=>{
    const div = document.createElement("div");
    div.className = "flex justify-between items-center bg-white p-2 rounded-lg border";
    div.innerHTML = `
      <div>
        <div class="text-sm font-medium">${p.nombre}</div>
        <div class="text-xs text-slate-500">${p.sucursal}</div>
      </div>
      <button class="text-red-500 text-xs" onclick="deleteItem('${STORES.PROMOTORES}',${p.id},loadPromotores)">Eliminar</button>
    `;
    lista.appendChild(div);
  });

  populatePromotoresForSucursal(document.getElementById("venta-sucursal")?.value);
}

function populatePromotoresForSucursal(suc) {
  const sel = document.getElementById("venta-promotor");
  if (!sel) return;

  sel.innerHTML = '<option value="">Seleccione un promotor...</option>';
  const subset = promotoresCache.filter(p=> !suc || p.sucursal === suc);

  if (subset.length === 0) {
    const opt = new Option("No hay promotores",""); opt.disabled = true;
    sel.add(opt);
  } else {
    subset.forEach(p=> sel.add(new Option(p.nombre, p.id)));
  }
}

/* ===========================================================
   METAS CRUD
   =========================================================== */
function handleAddMeta(e) {
  e.preventDefault();
  const f = e.target;

  const meta = {
    mes: parseInt(f.mes.value),
    sucursal: f.sucursal.value,
    producto: f.producto.value,
    meta: parseInt(f.meta.value)
  };

  if (!meta.mes || !meta.sucursal || !meta.producto || !meta.meta)
    return showToast("Complete los campos", true);

  const store = db.transaction(STORES.METAS,"readwrite").objectStore(STORES.METAS);
  const req = store.add(meta);

  req.onsuccess = () => {
    showToast("Meta agregada");
    f.reset();
    f.mes.value = new Date().getMonth()+1;
    loadMetas();
    loadDashboardData();
  };

  req.onerror = e => {
    if (e.target.error?.name === "ConstraintError")
      showToast("Ya existe una meta para esa combinación", true);
    else showToast("Error guardando meta", true);
  };
}

async function loadMetas() {
  const metas = await getAllFromDB(STORES.METAS);
  const tbody = document.getElementById("lista-metas");

  tbody.innerHTML = "";
  if (metas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-slate-500 py-4">No hay metas guardadas.</td></tr>';
    return;
  }

  metas.sort((a,b)=> a.mes - b.mes || a.sucursal.localeCompare(b.sucursal));

  metas.forEach(m=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="px-6 py-4 text-sm">${MESES[m.mes-1]}</td>
      <td class="px-6 py-4 text-sm">${m.sucursal}</td>
      <td class="px-6 py-4 text-sm">${m.producto}</td>
      <td class="px-6 py-4 text-sm font-medium">${m.meta}</td>
      <td class="px-6 py-4 text-sm">
        <button class="text-red-500" onclick="deleteItem('${STORES.METAS}',${m.id},loadMetas)">Eliminar</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ===========================================================
   VENTAS CRUD
   =========================================================== */
function handleAddVenta(e) {
  e.preventDefault();
  const f = e.target;

  const data = {
    fecha: f.fecha.value,
    sucursal: f.sucursal.value,
    producto: f.producto.value,
    promotorId: parseInt(f.promotor.value),
    cantidad: parseInt(f.cantidad.value)
  };

  if (!data.fecha || !data.sucursal || !data.producto || !data.promotorId || !data.cantidad)
    return showToast("Complete todos los campos", true);

  const store = db.transaction(STORES.VENTAS,"readwrite").objectStore(STORES.VENTAS);
  const req = store.add(data);

  req.onsuccess = () => {
    showToast("Venta registrada");
    f.reset();
    loadVentas();
    loadDashboardData();
  };
}

async function loadVentas() {
  const ventas = await getAllFromDB(STORES.VENTAS);
  const tbody = document.getElementById("lista-ventas");
  tbody.innerHTML = "";

  if (ventas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-slate-500">No hay ventas registradas.</td></tr>';
    return;
  }

  ventas.sort((a,b)=> b.fecha.localeCompare(a.fecha));
  const mapProm = new Map(promotoresCache.map(p=> [p.id,p.nombre]));

  ventas.forEach(v=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="px-6 py-4 text-sm">${v.fecha}</td>
      <td class="px-6 py-4 text-sm">${v.sucursal}</td>
      <td class="px-6 py-4 text-sm">${v.producto}</td>
      <td class="px-6 py-4 text-sm font-medium">${v.cantidad}</td>
      <td class="px-6 py-4 text-sm">${mapProm.get(v.promotorId)||"?"}</td>
      <td class="px-6 py-4 text-sm">
        <button class="text-red-500" onclick="deleteItem('${STORES.VENTAS}',${v.id},loadVentas)">Eliminar</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ===========================================================
   DASHBOARD (Barras, Donut, Cards)
   =========================================================== */
async function loadDashboardData() {
  if (!db) return;

  const nowMonth = new Date().getMonth()+1;
  const year = new Date().getFullYear();

  const [metas, ventas] = await Promise.all([
    getAllFromDB(STORES.METAS),
    getAllFromDB(STORES.VENTAS)
  ]);

  const metasMes = metas.filter(m=> m.mes === nowMonth);
  const ventasMes = ventas.filter(v=>{
    const d = new Date(v.fecha);
    return d.getMonth()+1===nowMonth && d.getFullYear()===year;
  });

  // Producto
  const dataProd = {};
  PRODUCTOS.forEach(p=> dataProd[p] = { meta:0, venta:0 });
  metasMes.forEach(m=> dataProd[m.producto].meta += m.meta);
  ventasMes.forEach(v=> dataProd[v.producto].venta += v.cantidad);

  renderBarChart(dataProd);

  // Donut general
  const totalMeta = metasMes.reduce((s,m)=> s+m.meta, 0);
  const totalVenta = ventasMes.reduce((s,v)=> s+v.cantidad,0);
  renderDonutChart(totalVenta, totalMeta);

  // Sucursales
  const dataSuc = {};
  SUCURSALES.forEach(s=> dataSuc[s] = { meta:0, venta:0 });
  metasMes.forEach(m=> dataSuc[m.sucursal].meta += m.meta);
  ventasMes.forEach(v=> dataSuc[v.sucursal].venta += v.cantidad);

  renderSucursalCards(dataSuc);

  // Promotores
  renderProductivityPanel();
}

function renderBarChart(data) {
  const ctx = document.getElementById("barChart").getContext("2d");
  if (barChartInstance) barChartInstance.destroy();

  const labels = Object.keys(data);
  barChartInstance = new Chart(ctx,{
    type:"bar",
    data:{
      labels,
      datasets:[
        {
          label:"Meta",
          data: labels.map(l=> data[l].meta),
          backgroundColor:"rgba(203,213,225,1)"
        },
        {
          label:"Venta",
          data: labels.map(l=> data[l].venta),
          backgroundColor:"rgba(37,99,235,1)"
        }
      ]
    },
    options:{ responsive:true }
  });
}

function renderDonutChart(venta, meta) {
  const ctx = document.getElementById("donutChart").getContext("2d");
  if (donutChartInstance) donutChartInstance.destroy();

  const porcentaje = meta===0 ? 0 : Math.round((venta/meta)*100);
  document.getElementById("donut-percentage").textContent = porcentaje+"%";

  donutChartInstance = new Chart(ctx,{
    type:"doughnut",
    data:{
      labels:["Alcanzado","Faltante"],
      datasets:[{
        data:[venta, Math.max(0, meta-venta)],
        backgroundColor:["rgba(37,99,235,1)","rgba(226,232,240,1)"],
        borderWidth:2
      }]
    },
    options:{ cutout:"70%", plugins:{ legend:{ display:false } } }
  });
}

function renderSucursalCards(data) {
  const cont = document.getElementById("sucursal-cards-container");
  cont.innerHTML = "";

  for (const s in data) {
    const d = data[s];
    const pct = d.meta===0 ? 0 : Math.round((d.venta/d.meta)*100);
    const color = pct>=100 ? "bg-green-500":"bg-blue-500";

    const card = document.createElement("div");
    card.className = "bg-white p-4 rounded-lg shadow-md border";
    card.innerHTML = `
      <h4 class="font-semibold text-slate-700">${s}</h4>
      <div class="text-xs text-slate-500 mb-2">${d.venta} / ${d.meta} piezas</div>
      <div class="w-full bg-slate-200 h-2 rounded-full">
        <div class="${color} h-2 rounded-full" style="width:${Math.min(pct,100)}%"></div>
      </div>
      <div class="text-right text-sm font-medium mt-1">${pct}%</div>`;
    cont.appendChild(card);
  }
}

async function renderProductivityPanel() {
  const cont = document.getElementById("productivity-container");
  cont.innerHTML = "";

  const metas = await getAllFromDB(STORES.METAS);
  const ventas = await getAllFromDB(STORES.VENTAS);
  const month = new Date().getMonth()+1;

  const metasMonth = metas.filter(m=> m.mes===month);
  const ventasMonth = ventas.filter(v=> (new Date(v.fecha)).getMonth()+1===month);

  const metasPorSuc = {};
  SUCURSALES.forEach(s=> metasPorSuc[s] = 0);
  metasMonth.forEach(m=> metasPorSuc[m.sucursal] += m.meta);

  const ventasPorProm = {};
  ventasMonth.forEach(v=>{
    ventasPorProm[v.promotorId] = (ventasPorProm[v.promotorId]||0) + v.cantidad;
  });

  promotoresCache.forEach(p=>{
    const total = ventasPorProm[p.id] || 0;
    const metaSuc = metasPorSuc[p.sucursal] || 0;

    const pct = metaSuc===0 ? 0 : Math.round((total/metaSuc)*100);

    const card = document.createElement("div");
    card.className = "bg-white p-4 rounded-lg border shadow-md";
    card.innerHTML = `
      <div class="flex justify-between">
        <div>
          <div class="text-sm font-medium">${p.nombre}</div>
          <div class="text-xs text-slate-500">${p.sucursal}</div>
        </div>
        <div class="text-lg font-bold">${total}</div>
      </div>

      <div class="w-full bg-slate-200 h-2 mt-2 rounded-full">
        <div class="${pct>=100?"bg-green-500":"bg-blue-500"} h-2 rounded-full" style="width:${Math.min(pct,100)}%"></div>
      </div>

      <div class="text-right text-sm mt-1">${pct}%</div>`;
    cont.appendChild(card);
  });

  if (promotoresCache.length === 0)
    cont.innerHTML = '<p class="text-slate-500">No hay promotores registrados.</p>';
}

/* ===========================================================
   UTILIDADES GENERALES
   =========================================================== */
function getAllFromDB(storeName) {
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(storeName,"readonly");
    const store = tx.objectStore(storeName);
    const req = store.getAll();
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = e=> reject(e.target.error);
  });
}

function deleteItem(store, id, callback) {
  if (!confirm("¿Eliminar registro?")) return;

  const req = db.transaction(store,"readwrite").objectStore(store).delete(id);

  req.onsuccess = () => {
    showToast("Registro eliminado");
    if (callback) callback();
    loadDashboardData();
  };
}

function showToast(msg, error=false) {
  const toast = document.getElementById("toast");
  const txt = document.getElementById("toast-message");

  txt.textContent = msg;
  toast.classList.remove("opacity-0","translate-y-10");
  toast.classList.add("opacity-100","translate-y-0", error ? "bg-red-500":"bg-gray-800");

  setTimeout(()=>{
    toast.classList.add("opacity-0","translate-y-10");
  },3000);
}

function openMessageModal(title, body) {
  document.getElementById("message-title").textContent = title;
  document.getElementById("message-body").innerHTML = body;
  const modal = document.getElementById("message-modal");
  modal.classList.remove("opacity-0","invisible");
}

function closeMessageModal() {
  const modal = document.getElementById("message-modal");
  modal.classList.add("opacity-0","invisible");
}

/* ===========================================================
   CONFIG + SINCRONIZACIÓN CON GIST
   (idéntico al original, pero limpísimo)
   =========================================================== */
async function loadGistConfigLocal() {
  const cfgs = await getAllFromDB(STORES.CONFIG);
  const id = cfgs.find(x=>x.id==="gistId")?.value || "";
  const token = cfgs.find(x=>x.id==="gistToken")?.value || "";

  document.getElementById("gist-id").value = id;
  document.getElementById("gist-token").value = token;

  return { gistId:id, gistToken:token };
}

async function saveGistConfig(id, token) {
  const store = db.transaction(STORES.CONFIG,"readwrite").objectStore(STORES.CONFIG);
  await store.put({ id:"gistId", value:id });
  await store.put({ id:"gistToken", value:token });
  showToast("Configuración guardada");
}

document.getElementById("btn-save-gist")?.addEventListener("click", e=>{
  e.preventDefault();
  saveGistConfig(
    document.getElementById("gist-id").value.trim(),
    document.getElementById("gist-token").value.trim()
  );
});

/* ===========================================================
   REGISTRO DEL SERVICE WORKER
   =========================================================== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js")
    .then(()=> console.log("SW registrado"))
    .catch(err=> console.warn("Error SW:", err));
}
</script>

</body>
</html>